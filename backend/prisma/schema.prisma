generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  password             String
  name                 String
  phone                String?
  role                 Role      @default(EMPLOYEE)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  companyId            String?
  resetToken           String?
  resetTokenExpiry     DateTime?
  failedLoginAttempts  Int       @default(0)
  lockedUntil          DateTime?
  lastLoginAt          DateTime?
  lastLoginIp          String?
  isVerified           Boolean   @default(false)
  verificationToken    String?
  verificationExpiry   DateTime?
  twoFactorSecret      String?
  twoFactorEnabled     Boolean   @default(false)
  permissions          Json?     @default("{}")
  assignedDeals        Deal[]
  assignedActivities   Activity[] @relation("AssignedActivities")
  comments             Comment[]
  auditLogs            AuditLog[]
  notifications        Notification[]
  refreshTokens        RefreshToken[]
  company              Company?  @relation(fields: [companyId], references: [id])

  @@map("users")
}

model RefreshToken {
  id          String   @id @default(cuid())
  token       String   @unique
  userId      String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Company {
  id          String     @id @default(cuid())
  name        String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  description String?
  activities  Activity[]
  contacts    Contact[]
  deals       Deal[]
  users       User[]
  comments    Comment[]
  auditLogs   AuditLog[]
  notifications Notification[]

  @@map("companies")
}

model Contact {
  id         String     @id @default(cuid())
  firstName  String
  lastName   String
  email      String?
  phone      String?
  companyId  String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  company    Company    @relation(fields: [companyId], references: [id])
  deals      Deal[]
  activities Activity[]

  @@index([companyId])
  @@index([email])
  @@index([companyId, email])
  @@map("contacts")
}

model Deal {
  id                String     @id @default(cuid())
  title             String
  value             Decimal?
  stage             DealStage  @default(LEAD)
  expectedCloseDate DateTime?
  companyId         String
  contactId         String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  closedAt          DateTime?
  assignedToId      String?
  lastContactDate   DateTime?
  leadScore         Int        @default(0)
  leadSource        LeadSource @default(WEBSITE)
  notes             String?
  priority          Priority   @default(MEDIUM)
  assignedTo        User?      @relation(fields: [assignedToId], references: [id])
  company           Company    @relation(fields: [companyId], references: [id])
  contact           Contact?   @relation(fields: [contactId], references: [id])
  activities        Activity[]

  @@index([companyId])
  @@index([companyId, stage])
  @@index([assignedToId])
  @@index([contactId])
  @@index([companyId, leadScore])
  @@index([companyId, priority])
  @@index([companyId, stage, priority])
  @@index([expectedCloseDate])
  @@map("deals")
}

model Activity {
  id            String         @id @default(cuid())
  title         String
  type          ActivityType   @default(TASK)
  status        ActivityStatus @default(SCHEDULED)
  description   String?
  scheduledDate DateTime
  companyId     String
  contactId     String?
  dealId        String?
  assignedToId  String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  company       Company        @relation(fields: [companyId], references: [id])
  contact       Contact?       @relation(fields: [contactId], references: [id])
  deal          Deal?          @relation(fields: [dealId], references: [id])
  assignedTo    User?          @relation("AssignedActivities", fields: [assignedToId], references: [id])

  @@index([companyId])
  @@index([companyId, scheduledDate])
  @@index([companyId, status])
  @@index([contactId])
  @@index([dealId])
  @@index([assignedToId])
  @@map("activities")
}

model Invite {
  id        String   @id @default(cuid())
  email     String
  companyId String
  role      Role
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("invites")
}

model Comment {
  id               String         @id @default(cuid())
  content          String
  commentableType  CommentableType
  commentableId    String
  userId           String
  companyId        String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  company          Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([commentableType, commentableId])
  @@index([companyId])
  @@index([userId])
  @@map("comments")
}

model AuditLog {
  id         String      @id @default(cuid())
  action     AuditAction
  entityType String
  entityId   String
  changes    Json?
  userId     String
  companyId  String
  createdAt  DateTime    @default(now())
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([companyId])
  @@index([userId])
  @@index([companyId, createdAt])
  @@index([companyId, entityType])
  @@map("audit_logs")
}

model Attachment {
  id             String         @id @default(cuid())
  filename       String
  originalName   String
  mimeType       String
  size           Int
  path           String
  url            String?
  attachableType AttachableType
  attachableId   String
  companyId      String
  uploadedBy     String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([attachableType, attachableId])
  @@index([companyId])
  @@index([uploadedBy])
  @@map("attachments")
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  entityType String?
  entityId   String?
  isRead    Boolean          @default(false)
  userId    String
  companyId String
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  company   Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([companyId])
  @@index([createdAt])
  @@map("notifications")
}

enum Role {
  ADMIN
  EMPLOYEE
}

enum CommentableType {
  DEAL
  CONTACT
  ACTIVITY
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum DealStage {
  LEAD
  QUALIFIED
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum ActivityType {
  TASK
  CALL
  MEETING
  EMAIL
  NOTE
}

enum ActivityStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum LeadSource {
  WEBSITE
  FACEBOOK
  GOOGLE_ADS
  LINKEDIN
  REFERRAL
  COLD_CALL
  EMAIL_CAMPAIGN
  TRADE_SHOW
  SOCIAL_MEDIA
  DIRECT_MAIL
  PARTNER
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AttachableType {
  DEAL
  CONTACT
  ACTIVITY
  COMMENT
}

enum NotificationType {
  DEAL_CREATED
  DEAL_UPDATED
  DEAL_ASSIGNED
  DEAL_STATUS_CHANGED
  CONTACT_CREATED
  CONTACT_UPDATED
  ACTIVITY_CREATED
  ACTIVITY_ASSIGNED
  ACTIVITY_DUE_SOON
  COMMENT_ADDED
  MENTION
  SYSTEM
}
