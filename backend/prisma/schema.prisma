generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  password             String
  plainPassword        String?   // For manager to view employee passwords
  name                 String
  phone                String?
  role                 Role      @default(EMPLOYEE)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  companyId            String?
  resetToken           String?
  resetTokenExpiry     DateTime?
  failedLoginAttempts  Int       @default(0)
  lockedUntil          DateTime?
  lastLoginAt          DateTime?
  lastLoginIp          String?
  isVerified           Boolean   @default(false)
  verificationToken    String?
  verificationExpiry   DateTime?
  twoFactorSecret      String?
  twoFactorEnabled     Boolean   @default(false)
  permissions          Json?     @default("{}")
  assignedDeals               Deal[]
  assignedActivities          Activity[] @relation("AssignedActivities")
  comments                    Comment[]
  auditLogs                   AuditLog[]
  notifications               Notification[]
  refreshTokens               RefreshToken[]
  notificationPreferences     NotificationPreference?
  pushSubscriptions           PushSubscription[]
  googleCalendarToken         GoogleCalendarToken?
  organizedMeetings           Meeting[] @relation("MeetingOrganizer")
  company                     Company?  @relation(fields: [companyId], references: [id])

  @@index([companyId, email]) // ✅ For finding users by company + email
  @@index([lastLoginAt]) // ✅ For "recently active users" queries
  @@map("users")
}

model RefreshToken {
  id          String   @id @default(cuid())
  token       String   @unique
  userId      String
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Company {
  id          String     @id @default(cuid())
  name        String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  description String?
  activities  Activity[]
  contacts    Contact[]
  deals       Deal[]
  users       User[]
  comments    Comment[]
  auditLogs   AuditLog[]
  notifications Notification[]
  exportTemplates ExportTemplate[]
  exportJobs  ExportJob[]
  meetings    Meeting[]
  subscriptions Subscription[]

  @@index([name]) // ✅ For company search/autocomplete
  @@map("companies")
}

model Contact {
  id         String     @id @default(cuid())
  firstName  String
  lastName   String
  email      String?
  phone      String?
  companyId  String
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  company    Company    @relation(fields: [companyId], references: [id])
  deals      Deal[]
  activities Activity[]
  meetings   Meeting[]

  @@index([companyId])
  @@index([email])
  @@index([companyId, email])
  @@index([firstName]) // ✅ For contact search
  @@index([lastName]) // ✅ For contact search
  @@index([companyId, firstName, lastName]) // ✅ Composite for filtered search
  @@map("contacts")
}

model Deal {
  id                String     @id @default(cuid())
  title             String
  value             Decimal?
  stage             DealStage  @default(LEAD)
  expectedCloseDate DateTime?
  companyId         String
  contactId         String?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  closedAt          DateTime?
  assignedToId      String?
  lastContactDate   DateTime?
  leadScore         Int        @default(0)
  leadSource        LeadSource @default(WEBSITE)
  notes             String?
  priority          Priority   @default(MEDIUM)
  assignedTo        User?      @relation(fields: [assignedToId], references: [id])
  company           Company        @relation(fields: [companyId], references: [id])
  contact           Contact?       @relation(fields: [contactId], references: [id])
  activities        Activity[]
  meetings          Meeting[]

  @@index([companyId])
  @@index([companyId, stage])
  @@index([assignedToId])
  @@index([contactId])
  @@index([companyId, leadScore])
  @@index([companyId, priority])
  @@index([companyId, stage, priority])
  @@index([expectedCloseDate])
  @@map("deals")
}

model Activity {
  id            String         @id @default(cuid())
  title         String
  type          ActivityType   @default(TASK)
  status        ActivityStatus @default(SCHEDULED)
  description   String?
  scheduledDate DateTime
  companyId     String
  contactId     String?
  dealId        String?
  assignedToId  String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  company       Company        @relation(fields: [companyId], references: [id])
  contact       Contact?       @relation(fields: [contactId], references: [id])
  deal          Deal?          @relation(fields: [dealId], references: [id])
  assignedTo    User?          @relation("AssignedActivities", fields: [assignedToId], references: [id])

  @@index([companyId])
  @@index([companyId, scheduledDate])
  @@index([companyId, status])
  @@index([contactId])
  @@index([dealId])
  @@index([assignedToId])
  @@index([title]) // ✅ For activity search
  @@index([companyId, title]) // ✅ Composite for filtered search
  @@map("activities")
}

model Invite {
  id        String   @id @default(cuid())
  email     String
  companyId String
  role      Role
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("invites")
}

model Comment {
  id               String         @id @default(cuid())
  content          String
  commentableType  CommentableType
  commentableId    String
  userId           String
  companyId        String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  company          Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([commentableType, commentableId])
  @@index([companyId])
  @@index([userId])
  @@map("comments")
}

model AuditLog {
  id         String      @id @default(cuid())
  action     AuditAction
  entityType String
  entityId   String
  changes    Json?
  userId     String
  companyId  String
  createdAt  DateTime    @default(now())
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([companyId])
  @@index([userId])
  @@index([companyId, createdAt])
  @@index([companyId, entityType])
  @@map("audit_logs")
}

model Attachment {
  id             String         @id @default(cuid())
  filename       String
  originalName   String
  mimeType       String
  size           Int
  path           String
  url            String?
  attachableType AttachableType
  attachableId   String
  companyId      String
  uploadedBy     String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([attachableType, attachableId])
  @@index([companyId])
  @@index([uploadedBy])
  @@map("attachments")
}

model Notification {
  id         String           @id @default(cuid())
  type       NotificationType
  title      String
  message    String
  entityType String?
  entityId   String?
  isRead     Boolean          @default(false)
  isMuted    Boolean          @default(false)
  snoozedUntil DateTime?
  groupKey   String?          // For grouping similar notifications
  groupCount Int              @default(1) // Count of grouped notifications
  userId     String
  companyId  String
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  company    Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, groupKey])
  @@index([companyId])
  @@index([createdAt])
  @@index([snoozedUntil])
  @@map("notifications")
}

model NotificationPreference {
  id             String           @id @default(cuid())
  userId         String           @unique
  
  // Channel preferences for each notification type
  emailEnabled   Boolean          @default(true)
  pushEnabled    Boolean          @default(true)
  inAppEnabled   Boolean          @default(true)
  
  // Type-specific preferences (JSON object mapping NotificationType to enabled channels)
  typePreferences Json            @default("{}")
  
  // Sound and visual preferences
  soundEnabled   Boolean          @default(true)
  soundType      String           @default("default") // "default", "subtle", "none"
  
  // Quiet hours (24-hour format)
  quietHoursEnabled Boolean        @default(false)
  quietHoursStart   String?        // e.g., "22:00"
  quietHoursEnd     String?        // e.g., "08:00"
  
  // Muted entities (JSON array of {entityType, entityId})
  mutedEntities  Json             @default("[]")
  
  // Grouping preferences
  groupingEnabled Boolean          @default(true)
  groupingWindow  Int              @default(300) // seconds (5 minutes)
  
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notification_preferences")
}

model PushSubscription {
  id         String   @id @default(cuid())
  userId     String
  endpoint   String   @unique
  keys       Json     // {p256dh: string, auth: string}
  userAgent  String?  // Browser/device info
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("push_subscriptions")
}

model GoogleCalendarToken {
  id              String   @id @default(cuid())
  userId          String   @unique
  accessToken     String   // Encrypted
  refreshToken    String   // Encrypted
  tokenExpiry     DateTime
  calendarId      String   @default("primary")
  syncToken       String?  // For incremental sync
  channelId       String?  // For push notifications
  resourceId      String?  // Google's resource ID for the watch
  channelExpiry   DateTime? // When the watch expires
  isConnected     Boolean  @default(true)
  lastSyncAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([channelId])
  @@map("google_calendar_tokens")
}

model Meeting {
  id                String         @id @default(cuid())
  title             String
  description       String?
  location          String?
  startTime         DateTime
  endTime           DateTime
  timeZone          String         @default("UTC")
  isAllDay          Boolean        @default(false)
  status            MeetingStatus  @default(SCHEDULED)
  
  // Relationships
  organizerId       String
  companyId         String
  dealId            String?
  contactId         String?
  
  // Attendees (JSON array of {email, name, responseStatus})
  attendees         Json?          @default("[]")
  
  // Google Calendar sync
  googleEventId     String?        @unique
  googleCalendarId  String?        @default("primary")
  googleMeetLink    String?        // Auto-generated Google Meet link
  isSyncedToGoogle  Boolean        @default(false)
  lastGoogleSync    DateTime?
  
  // Reminders (JSON array of {minutes: number, method: 'email'|'popup'|'notification'})
  reminders         Json?          @default("[{\"minutes\": 15, \"method\": \"notification\"}, {\"minutes\": 60, \"method\": \"email\"}]")
  
  // Recurrence (JSON with rrule, until, count, etc.)
  recurrence        Json?
  isRecurring       Boolean        @default(false)
  
  // Notes for the meeting
  agenda            String?
  notes             String?        // Post-meeting notes
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  organizer         User              @relation("MeetingOrganizer", fields: [organizerId], references: [id])
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  deal              Deal?             @relation(fields: [dealId], references: [id], onDelete: SetNull)
  contact           Contact?          @relation(fields: [contactId], references: [id], onDelete: SetNull)
  meetingReminders  MeetingReminder[]
  
  @@index([companyId])
  @@index([organizerId])
  @@index([dealId])
  @@index([contactId])
  @@index([startTime])
  @@index([status])
  @@index([companyId, startTime])
  @@index([organizerId, startTime])
  @@index([googleEventId])
  @@map("meetings")
}

model MeetingReminder {
  id            String         @id @default(cuid())
  meetingId     String
  method        ReminderMethod @default(NOTIFICATION)
  minutesBefore Int
  scheduledFor  DateTime
  sentAt        DateTime?
  createdAt     DateTime       @default(now())
  
  meeting       Meeting        @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  
  @@index([meetingId])
  @@index([scheduledFor, sentAt])
  @@map("meeting_reminders")
}

enum Role {
  ADMIN
  MANAGER
  SALES
  EMPLOYEE
}

enum CommentableType {
  DEAL
  CONTACT
  ACTIVITY
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
}

enum DealStage {
  LEAD
  QUALIFIED
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

enum ActivityType {
  TASK
  CALL
  MEETING
  EMAIL
  NOTE
}

enum ActivityStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum LeadSource {
  WEBSITE
  FACEBOOK
  GOOGLE_ADS
  LINKEDIN
  REFERRAL
  COLD_CALL
  EMAIL_CAMPAIGN
  TRADE_SHOW
  SOCIAL_MEDIA
  DIRECT_MAIL
  PARTNER
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AttachableType {
  DEAL
  CONTACT
  ACTIVITY
  COMMENT
}

enum NotificationType {
  DEAL_CREATED
  DEAL_UPDATED
  DEAL_ASSIGNED
  DEAL_STATUS_CHANGED
  CONTACT_CREATED
  CONTACT_UPDATED
  ACTIVITY_CREATED
  ACTIVITY_ASSIGNED
  ACTIVITY_DUE_SOON
  COMMENT_ADDED
  MENTION
  SYSTEM
  MEETING_CREATED
  MEETING_UPDATED
  MEETING_REMINDER
  MEETING_CANCELLED
}

enum MeetingStatus {
  SCHEDULED
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ReminderMethod {
  EMAIL
  NOTIFICATION
  POPUP
  SMS
}

model ExportTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  entityType  String   // contacts, deals, activities, companies
  fields      Json     // Selected fields to export
  filters     Json?    // Default filters (date range, status, etc.)
  format      String   @default("csv") // csv, excel, json, xml
  userId      String
  companyId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  exportJobs  ExportJob[]
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@map("export_templates")
}

model ExportJob {
  id            String    @id @default(cuid())
  entityType    String    // contacts, deals, activities, companies
  format        String    // csv, excel, json, xml
  status        String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  schedule      String?   // once, daily, weekly, monthly
  filters       Json?     // Date range, status filters, etc.
  fields        Json?     // Selected fields
  templateId    String?
  fileUrl       String?   // S3 or local path to generated file
  fileName      String?
  fileSize      Int?
  totalRecords  Int?
  progress      Int       @default(0) // Percentage 0-100
  errorMessage  String?
  startedAt     DateTime?
  completedAt   DateTime?
  expiresAt     DateTime? // File expiration (24 hours after completion)
  userId        String
  companyId     String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  template      ExportTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("export_jobs")
}
// ============================================
// SUBSCRIPTION & PAYMENT MODELS
// ============================================

enum PlanType {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
  TRIALING
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model SubscriptionPlan {
  id                String         @id @default(cuid())
  name              String         @unique
  type              PlanType       @unique
  price             Decimal        @default(0)
  currency          String         @default("INR")
  billingCycle      String         @default("monthly") // monthly, yearly
  features          Json           // List of features
  maxUsers          Int            @default(1)
  maxDeals          Int            @default(100)
  maxContacts       Int            @default(500)
  maxStorage        Int            @default(1048576) // 1GB in KB
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  subscriptions     Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                String              @id @default(cuid())
  companyId         String
  planId            String
  status            SubscriptionStatus  @default(TRIALING)
  startDate         DateTime            @default(now())
  endDate           DateTime?
  trialEndsAt       DateTime?
  cancelledAt       DateTime?
  razorpaySubscriptionId String?        @unique
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  company           Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan              SubscriptionPlan    @relation(fields: [planId], references: [id])
  payments          Payment[]

  @@index([companyId])
  @@index([status])
  @@index([endDate])
  @@map("subscriptions")
}

model Payment {
  id                    String         @id @default(cuid())
  subscriptionId        String
  amount                Decimal
  currency              String         @default("INR")
  status                PaymentStatus  @default(PENDING)
  razorpayOrderId       String?        @unique
  razorpayPaymentId     String?        @unique
  razorpaySignature     String?
  paymentMethod         String?
  failureReason         String?
  paidAt                DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  subscription          Subscription   @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}