name: Security Scanning

on:
  push:
    branches: [main, develop, features]
  pull_request:
    branches: [main, develop, features]
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  # ========================
  # npm Audit - Backend
  # ========================
  npm-audit-backend:
    name: npm Audit (Backend)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run npm audit
        working-directory: ./backend
        run: |
          echo "Running npm audit..."
          npm audit --json > audit-results.json || true
          
          # Parse results
          HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
          
          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"
          
          # Fail if critical or high vulnerabilities found
          if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "0" ]; then
            echo "::error::Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            npm audit --audit-level=high
            exit 1
          fi
          
          echo "âœ… No high or critical vulnerabilities found"

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-npm-audit-results
          path: backend/audit-results.json
          retention-days: 30

  # ========================
  # npm Audit - Frontend
  # ========================
  npm-audit-frontend:
    name: npm Audit (Frontend)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run npm audit
        working-directory: ./frontend
        run: |
          echo "Running npm audit..."
          npm audit --json > audit-results.json || true
          
          HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
          
          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"
          
          if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "0" ]; then
            echo "::error::Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            npm audit --audit-level=high
            exit 1
          fi
          
          echo "âœ… No high or critical vulnerabilities found"

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-npm-audit-results
          path: frontend/audit-results.json
          retention-days: 30

  # ========================
  # Trivy - File System Scan
  # ========================
  trivy-fs-scan:
    name: Trivy File System Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (Backend)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

      - name: Run Trivy vulnerability scanner (Frontend)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './frontend'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: '.'
          category: 'trivy-fs'

  # ========================
  # Trivy - Docker Image Scan
  # ========================
  trivy-docker-scan:
    name: Trivy Docker Image Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build backend Docker image
        working-directory: ./backend
        run: docker build -f Dockerfile.prod -t crm-backend:test .

      - name: Run Trivy on backend image
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'crm-backend:test'
          format: 'sarif'
          output: 'trivy-backend-image.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Build frontend Docker image
        working-directory: ./frontend
        run: docker build -f Dockerfile -t crm-frontend:test .

      - name: Run Trivy on frontend image
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          image-ref: 'crm-frontend:test'
          format: 'sarif'
          output: 'trivy-frontend-image.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Docker scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: '.'
          category: 'trivy-docker'

  # ========================
  # Snyk Security Scan
  # ========================
  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    # Only run if SNYK_TOKEN is configured
    if: ${{ secrets.SNYK_TOKEN != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run Snyk to check backend
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=high --file=backend/package.json

      - name: Run Snyk to check frontend
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=high --file=frontend/package.json

      - name: Run Snyk to check Docker images
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: node:20-alpine
          args: --severity-threshold=high

  # ========================
  # OSSGADGET (Microsoft OSS Scanner)
  # ========================
  ossgadget-scan:
    name: OSS Gadget Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OSS Gadget
        run: |
          dotnet tool install -g Microsoft.CST.OSSGadget.CLI || true
          dotnet tool update -g Microsoft.CST.OSSGadget.CLI || true

      - name: Scan backend dependencies
        working-directory: ./backend
        run: |
          echo "Scanning backend package.json..."
          oss-detect-backdoor package.json || echo "Scan completed with warnings"
          oss-find-squats package.json || echo "Scan completed with warnings"
        continue-on-error: true

      - name: Scan frontend dependencies
        working-directory: ./frontend
        run: |
          echo "Scanning frontend package.json..."
          oss-detect-backdoor package.json || echo "Scan completed with warnings"
          oss-find-squats package.json || echo "Scan completed with warnings"
        continue-on-error: true

  # ========================
  # License Compliance Check
  # ========================
  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check backend licenses
        working-directory: ./backend
        run: |
          npm ci
          license-checker --summary --excludePrivatePackages > backend-licenses.txt
          cat backend-licenses.txt
          
          # Check for forbidden licenses
          FORBIDDEN="GPL-2.0 GPL-3.0 AGPL"
          for license in $FORBIDDEN; do
            if grep -q "$license" backend-licenses.txt; then
              echo "::error::Forbidden license detected: $license"
              exit 1
            fi
          done

      - name: Check frontend licenses
        working-directory: ./frontend
        run: |
          npm ci
          license-checker --summary --excludePrivatePackages > frontend-licenses.txt
          cat frontend-licenses.txt
          
          FORBIDDEN="GPL-2.0 GPL-3.0 AGPL"
          for license in $FORBIDDEN; do
            if grep -q "$license" frontend-licenses.txt; then
              echo "::error::Forbidden license detected: $license"
              exit 1
            fi
          done

      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: |
            backend/backend-licenses.txt
            frontend/frontend-licenses.txt
          retention-days: 90

  # ========================
  # Dependency Review (PRs only)
  # ========================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-1.0, AGPL-3.0
          comment-summary-in-pr: always

  # ========================
  # Security Summary & Notification
  # ========================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [npm-audit-backend, npm-audit-frontend, trivy-fs-scan, license-check]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- npm Audit (Backend): ${{ needs.npm-audit-backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- npm Audit (Frontend): ${{ needs.npm-audit-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trivy File System: ${{ needs.trivy-fs-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- License Check: ${{ needs.license-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in [Security tab](https://github.com/${{ github.repository }}/security)" >> $GITHUB_STEP_SUMMARY

      - name: Create issue on failure
        if: |
          needs.npm-audit-backend.result == 'failure' ||
          needs.npm-audit-frontend.result == 'failure' ||
          needs.trivy-fs-scan.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Critical Security Vulnerabilities Detected';
            const body = `## Security Scan Failed
            
            Critical or high severity vulnerabilities were detected in the latest security scan.
            
            **Failed Checks:**
            - npm Audit (Backend): ${{ needs.npm-audit-backend.result }}
            - npm Audit (Frontend): ${{ needs.npm-audit-frontend.result }}
            - Trivy Scan: ${{ needs.trivy-fs-scan.result }}
            
            **Action Required:**
            1. Review the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Check the [Security tab](https://github.com/${{ github.repository }}/security) for details
            3. Update vulnerable dependencies using \`npm audit fix\` or manual updates
            4. Re-run security scan after fixes
            
            **Severity:** CRITICAL - Block deployment until resolved
            
            **Triggered by:** ${{ github.event_name }} on ${{ github.ref }}
            **Commit:** ${{ github.sha }}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'critical', 'dependencies']
            });
